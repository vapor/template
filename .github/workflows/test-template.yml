name: test
concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true
on:
  pull_request: { types: [opened, reopened, synchronize, ready_for_review] }

jobs:
  # Build the toolbox, then run vapor new and build the docker container for all options
  test-new:
    if: ${{ !github.event.pull_request.draft }}
    strategy:
      fail-fast: false
      matrix:
        fluentflags:
          - '--no-fluent'
          - '--fluent.db mysql'
          - '--fluent.db postgres'
          - '--fluent.db sqlite'
          - '--fluent.db mongo'
        leafflags:
          - '--leaf'
          - '--no-leaf'
    runs-on: ubuntu-latest
    steps:
      - name: Checkout the toolbox
        uses: actions/checkout@v3
        with:
          repository: vapor/toolbox
          path: toolbox
      - name: Generate a project from the template
        run: |
          swift run --package-path toolbox \
            vapor new template-test \
              --template ${{ github.event.pull_request.head.repo.clone_url }} \
              --branch ${{ github.head_ref }} \
              --no-commit -o template-test \
              ${{ matrix.fluentflags }} ${{ matrix.leafflags }}
      - name: Build and test template
        run: swift test --package-path template-test
      - name: Build Docker container
        run: docker compose --project-directory template-test build
